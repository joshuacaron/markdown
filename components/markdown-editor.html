<polymer-element name="markdown-editor" layout vertical attributes="markdown syncScrollSetting fontSize monospaceFont renderKaTeX">
  <!-- outermost template defines the element's shadow DOM -->
  <template>
    <link href="katex.min.css" rel="stylesheet" type="text/css">
    <script src="katex.min.js"></script>
    <style>
      #preview {
        padding: 0 15px;
        margin:0;
        overflow-x:hidden;
        overflow-y:auto;
        font-family:"Open Sans";
        font-size:{{fontSize}};
        color:#212121;
        cursor:pointer;
      }
      #markdown {
        outline:none;
        border:none;
        border-right:solid 1px #e0e0e0;
        resize:none;
        overflow-y:auto;
        overflow-x:hidden;
        padding:15px;
        font-family:{{monospaceFont | markdownFont}};
        font-size:{{fontSize}};
        color:#212121;
      }
      #wrapper {
        height:100%;
        width:100%;
      }
    </style>
    <div id="wrapper" layout horizontal flex>
      <textarea id="markdown" value="{{markdown}}" autofocus flex></textarea>
      <div id="preview" flex></div>
    </div>
  </template>
  <script>
      Polymer('markdown-editor', {
      syncScrollSetting:true,
      renderKaTeX:false,
      renderKaTeXChanged:function(){
        if(this.renderKaTeX == true){
          this.injectBoundHTML(this.renderLaTeX(markdown.toHTML(this.markdown)),this.$.preview);
        }
        else {
          this.injectBoundHTML(markdown.toHTML(this.markdown),this.$.preview);

        }
      },
      markdown:"",
      markdownChanged:function(){

        if(this.renderKaTeX == true){
          this.injectBoundHTML(this.renderLaTeX(markdown.toHTML(this.markdown)),this.$.preview);
        }
        else {
          this.injectBoundHTML(markdown.toHTML(this.markdown),this.$.preview);

        }

        if(this.syncScrollSetting == true){
          cursor = this.$.markdown.selectionStart;
          n = this.markdown.length;
          secondLast = this.markdown.slice(n-2,n-1);
          if (cursor==n && secondLast=="\n"){
            $(this.$.markdown).scrollTop(this.$.markdown.scrollHeight);
            $(this.$.preview).scrollTop(this.$.preview.scrollHeight);
          };
        }
      },

      renderLaTeX:function(x){
        splitLaTeXDisplay = x.split("$$");
        if (splitLaTeXDisplay.length>1&&splitLaTeXDisplay.length%2==1){
          formattedMath = "";
          for (i=0;i<splitLaTeXDisplay.length;++i){
            if (i%2==0){
              formattedMath += splitLaTeXDisplay[i];
            }
            else {
              formattedMath += katex.renderToString(splitLaTeXDisplay[i],{displayMode:true});
            }
          }
        }
        else {
          formattedMath = x;
        }

        splitLaTeX = formattedMath.split("$");
        if (splitLaTeX.length>1&&splitLaTeX.length%2==1){
          formattedMath = "";
          for (i=0;i<splitLaTeX.length;++i){
            if (i%2==0){
              formattedMath += splitLaTeX[i];
            }
            else {
              formattedMath += katex.renderToString(splitLaTeX[i]);
            }
          }
          return formattedMath;
        }
        else {
          return x;
        }
      },

      syncScroll:function(){
        if (this.syncScrollSetting == true){
          wrapperHeight = this.$.markdown.style.height;
          innerHeight = this.$.markdown.scrollHeight;
          previewHeight = this.$.preview.scrollHeight;
          ratio = (innerHeight - wrapperHeight)/(previewHeight - wrapperHeight);
          previewPosition = $(this.$.markdown).scrollTop() * ratio;
          $(this.$.preview).scrollTop(previewPosition);
        }
      },
      markdownFont:function(value){
        if (value== true){
          return "Droid Sans Mono";
        }
        else {
          return "Open Sans";
        }
      },
      ready:function(){
        editor = this;
        this.$.preview.addEventListener("click",function(){
          var copyFrom = $('<textarea/>');
          copyFrom.text(markdown.toHTML(editor.markdown));
          $('body').append(copyFrom);
          copyFrom.select();
          document.execCommand('copy');
          copyFrom.remove();
          document.querySelector("#toast").show();
        })
        this.$.markdown.addEventListener("scroll",this.syncScroll.bind(this));
      }
    });
</script>
</polymer-element>