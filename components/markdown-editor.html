<polymer-element name="markdown-editor" layout vertical attributes="markdown syncScrollSetting fontSize monospaceFont renderKaTeX">
  <template>
    <link href="katex.min.css" rel="stylesheet" type="text/css">
    <script src="katex.min.js"></script>
    <style>
      #preview {
        padding: 0 15px;
        margin:0;
        overflow-x:hidden;
        overflow-y:auto;
        font-family:"Open Sans";
        font-size:{{fontSize}};
        color:#212121;
        cursor:pointer;
      }
      #markdown {
        outline:none;
        border:none;
        border-right:solid 1px #e0e0e0;
        resize:none;
        overflow-y:auto;
        overflow-x:hidden;
        padding:15px;
        font-family:{{monospaceFont | markdownFont}};
        font-size:{{fontSize}};
        color:#212121;
      }
      #wrapper {
        height:100%;
        width:100%;
      }
    </style>
    <div id="wrapper" layout horizontal flex>
      <textarea id="markdown" value="{{markdown}}" autofocus flex></textarea>
      <div id="preview" flex></div>
    </div>
  </template>
  <script>
      Polymer('markdown-editor', {
      syncScrollSetting:true,
      renderKaTeX:false,
      renderKaTeXChanged:function(){
        if(this.renderKaTeX == true){
          this.injectBoundHTML(this.renderLaTeX(markdown.toHTML(this.markdown)),this.$.preview);
        }
        else {
          this.injectBoundHTML(markdown.toHTML(this.markdown),this.$.preview);

        }
      },
      markdown:"",
      markdownChanged:function(){

        if(this.renderKaTeX == true){
          this.injectBoundHTML(this.renderLaTeX(markdown.toHTML(this.markdown)),this.$.preview);
        }
        else {
          this.injectBoundHTML(markdown.toHTML(this.markdown),this.$.preview);

        }

        cursor = this.$.markdown.selectionStart;
        n = this.markdown.length;
        secondLast = this.markdown.slice(n-2,n-1);
        if (cursor==n && secondLast=="\n"){
          $(this.$.markdown).scrollTop(this.$.markdown.scrollHeight);
          if(this.syncScrollSetting == true){
            $(this.$.preview).scrollTop(this.$.preview.scrollHeight);
          };
        };
      },

      renderLaTeX:function(x){
        // Useless character that is unlikely to be typed. In practice doesn't seem to matter even if is typed.
        // Need to escape dollar signs or can't use at all.
        x = x.replace(/\\\$/g,"Ž");

        lines = x.split("\n");
        output = "";
        for(j=0;j<lines.length;j++){
          lineTemp = "";
          line = "";
          splitDisplay = lines[j].split("$$");
          if(splitDisplay.length>1 && splitDisplay.length%2==1){
            for(i=0;i<splitDisplay.length;++i){
              if(i%2==0){
                lineTemp += splitDisplay[i];
              }
              else {
                try{lineTemp += katex.renderToString(splitDisplay[i],{displayMode:true});}
                catch(err){lineTemp += "<p style=\"text-align:center;\">ŽŽ" + splitDisplay[i] + 'ŽŽ</p>';}
              }
            }
          }
          else {
            lineTemp = lines[j];
          }

          splitInline = lineTemp.split("$");
          if(splitInline.length>1 && splitInline.length%2==1){
            for(k=0;k<splitInline.length;++k){
              if(k%2==0){
                line += splitInline[k];
              }
              else {
                try{line += katex.renderToString(splitInline[k]);}
                catch(err){line += '$' + splitInline[k] + '$';}
              }
            }
          }
          else {
            line = lineTemp;
          }

          output += line;
        }
        output = output.replace(/Ž/g,"$");
        return output;
      },

      syncScroll:function(){
        if (this.syncScrollSetting == true){
          wrapperHeight = this.$.markdown.style.height;
          innerHeight = this.$.markdown.scrollHeight;
          previewHeight = this.$.preview.scrollHeight;
          ratio = (innerHeight - wrapperHeight)/(previewHeight - wrapperHeight);
          previewPosition = $(this.$.markdown).scrollTop() * ratio;
          $(this.$.preview).scrollTop(previewPosition);
        }
      },
      markdownFont:function(value){
        if (value== true){
          return "Droid Sans Mono";
        }
        else {
          return "Open Sans";
        }
      },
      ready:function(){
        editor = this;
        this.$.preview.addEventListener("click",function(){
          var copyFrom = $('<textarea/>');
          copyFrom.text(markdown.toHTML(editor.markdown));
          $('body').append(copyFrom);
          copyFrom.select();
          document.execCommand('copy');
          copyFrom.remove();
          document.querySelector("#toast").show();
        })
        this.$.markdown.addEventListener("scroll",this.syncScroll.bind(this));
      }
    });
</script>
</polymer-element>